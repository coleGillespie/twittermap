
// -------------------------------------------------- //

module.exports.install = function(server) {

  var info   = server.database
  ,   cradle = require('./neo-cradle/lib/cradle')
  ,   dir    = process.cwd() + "/db/"
  ;

  var db = server.db = new(cradle.Connection)(info.host, info.port || 5984, {
    auth: info.auth
  }).database(info.dbname);


  // Check connection
  // -------------------------------------------------- //

  db.exists(function (err, exists) {
    if (err) {
      server.error("CouchDB " + err);
    } else if (exists) {
      info.connected = true;
      server.info("CouchDB".cyan + " is connected at " + info.host.cyan);
    } else {
      server.warn('CouchDB database does not exist. Now creating...');
      db.create(function(err) {
        if (err) { return App.error(err); }
        App.info("Database " + info.dbname.cyan + " was created.");
      });
    }
  });


  // Setup Model
  // -------------------------------------------------- //
  
  require("./model")(server);

  
  // Database Events
  // -------------------------------------------------- //
  
  App.db.changes({ include_doc: true }).on('response', function (res) {

    res.on('data', function (change) {
      change.id && db.get(change.id, function(err, doc) {
        server.emit("change-" + doc.type, change, doc);
      })
    });
    
    res.on('end', function () {
      server.emit("db-end");
    });

  });

  
};
