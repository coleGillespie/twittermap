// -------------------------------------------------- //
// Default Routing
// -------------------------------------------------- //

var bcrypt = require("bcrypt");

module.exports = function(context) {

    context.get('/logout', function(req, res){
        // destroy the user's session to log them out
        // will be re-created next request
        
        if (req.session) {
            req.session.destroy(function(){
                res.redirect('/');
            });
        } else {
            res.redirect('/');
        }
    });

    context.get('/login', function(req, res){

        if (req.session.user) {
            req.session.success = 'Authenticated as ' + req.session.user.username
                + ' click to <a href="/logout">logout</a>. ';
        }

        res.render("login", { user: User });
    });

    context.post('/login', function(req, res){

        App.auth.authenticate(req.body.user.username, req.body.user.password, function(err, user){
            
            if (user) {
                // Regenerate session when signing in
                // to prevent fixation 
                req.session.regenerate(function(){
                    // Store the user's primary key 
                    // in the session store to be retrieved,
                    // or in this case the entire user object
                    req.session.user = user;
                    req.session.success = "Welcome back, " + user.username;
                    res.redirect('/');
                });
                
            } else {
                req.session.error = 'Authentication failed, please check your '
                    + ' username and password.'
                    + ' (use "nate" and "password")';
                res.redirect('back');
            }
            
        });

    });

    context.get('/register', function(req, res){
        res.render("register", { user: User });
    });

    context.get('/register', function(req, res){

        new User(req.body.user).save(function() {
            req.sesssion.success = "Successfully registered!"
            res.render("index", { user: User });
        });

    });

}
