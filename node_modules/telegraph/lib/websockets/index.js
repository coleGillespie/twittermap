// Telegraph Sockets
// Sets up websockets (currently through socket.io)
// -------------------------------------------------- //

var fs  = require("fs");

module.exports.setup = function(server) {

    server.io = require('socket.io').listen(server.express);
    server.io.configure(function() {
        server.io.set("log level", (server.silent_mode) ? 0 : 2);
    });

    server.websocket_events = [];

    server.receive = function(name, action) {
        
        server.websocket_events.push({
            name   : name, 
            action : function(data) {
                server.emit(name, data);
            }
        });

    };

    server.send = function(name, values) {
        server.io.sockets.emit(name, values);
    };

    server.broadcast = function(name, values) {
        server.io.sockets.broadcast(name, values);
    };
    
    // Add a clientside helper method
    server.on("/js/telegraph.js", function(req, res) {

        res.contentType("text/javascript");

        fs.readFile(__dirname + "/client/receiver.js", function(err, content) {
            res.send(content);
        });
        
    });
};


module.exports.install = function(server) {

    var events = server.websocket_events;
    
    server.io.sockets.on("connection", function(socket) {

        // Add websocket events
        events.forEach(function(e) {

            // Is it the connection event?
            if (e.name === "connection") {
                // yes : fire the event
                e.action(socket);
            } else { 
                // no : register the event
                socket.on(e.name, e.action);
            }
            
        });

    });
    
};
